#Q: https://datalemur.com/questions/top-fans-rank


WITH artist_songs AS (
    SELECT ar.artist_id, ar.artist_name, sg.song_id
    FROM artists ar
    INNER JOIN songs sg ON ar.artist_id = sg.artist_id
),
ranked_artists AS (
    SELECT ars.artist_name,
           COUNT(gsr.rank) AS rank_count
    FROM artist_songs ars
    INNER JOIN global_song_rank gsr ON ars.song_id = gsr.song_id
    WHERE gsr.rank < 10
    GROUP BY ars.artist_name
),
artist_ranks AS (
    SELECT artist_name,
           rank_count,
           DENSE_RANK() OVER (ORDER BY rank_count DESC) AS artist_rank_count,
           ROW_NUMBER() OVER (PARTITION BY rank_count ORDER BY rank_count DESC) AS artist_rank
    FROM ranked_artists
)
SELECT artist_name, artist_rank_count
FROM artist_ranks
WHERE artist_rank_count < 6
  AND (artist_rank < 2 OR artist_rank_count <> 5)
ORDER BY artist_rank_count, artist_rank;

